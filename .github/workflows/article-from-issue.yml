name: æŠ•ç¨¿Issueã‹ã‚‰è¨˜äº‹ã‚’ç”Ÿæˆ

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  generate-article:
    if: startsWith(github.event.issue.title, '[è¨˜äº‹]')
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: Issueå†…å®¹ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        id: generate
        run: |
          mkdir -p docs/contents

          ISSUE_NUMBER=${{ github.event.issue.number }}
          TITLE=$(echo "${{ github.event.issue.title }}" | sed 's/^\[è¨˜äº‹\] //')
          DATE=$(date "+%Y-%m-%d")
          FILENAME_RAW=$(echo "${{ github.event.issue.body }}" | awk '/^### ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«å/{getline; getline; print $0}' | xargs)
          FILENAME="docs/contents/${FILENAME_RAW}.md"
          
          AUTHOR=$(echo "${{ github.event.issue.body }}" | awk '/^### ğŸ–‹ è‘—è€…å/{getline; getline; print $0}' | xargs)
          TAGS=$(echo "${{ github.event.issue.body }}" \
            | awk '/^### ğŸ· ã‚¿ã‚°/{getline; getline; print $0}' \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's/, */, /g' \
            | tr -s ' ' \
            | xargs \
            | tr ',' '\n' | sed 's/^ *//;s/ *$//' | sort -u | paste -sd, -)

          BODY=$(echo "${{ github.event.issue.body }}" | awk '/^### ğŸ“ è¨˜äº‹æœ¬æ–‡/{flag=1; next} flag {print}')
          
          echo "ä½œæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«: $FILENAME"
          echo "title: $TITLE"
          echo "author: $AUTHOR"
          echo "tags: [$TAGS]"
          echo "body: $BODY"
          
          echo "---" > $FILENAME
          echo "title: '$TITLE'" >> $FILENAME
          echo "author: $AUTHOR" >> $FILENAME
          echo "date: $DATE" >> $FILENAME
          echo "tags: [${TAGS}]" >> $FILENAME
          echo "---" >> $FILENAME
          echo "" >> $FILENAME
          echo "$BODY" >> $FILENAME

          echo "filename=$FILENAME" >> $GITHUB_OUTPUT

      - name: Gitãƒ–ãƒ©ãƒ³ãƒä½œæˆãƒ»ã‚³ãƒŸãƒƒãƒˆãƒ»PRä½œæˆ
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "æŠ•ç¨¿è¨˜äº‹: ${{ github.event.issue.title }}"
          branch: "post/${{ github.event.issue.number }}"
          base: dev
          title: "${{ github.event.issue.title }}"
          body: "ã“ã®PRã¯ Issue #${{ github.event.issue.number }} ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚"
          add-paths: docs/contents/*.md
