name: 投稿Issueから記事を生成

on:
  issues:
    types: [opened]

jobs:
  generate-article:
    if: startsWith(github.event.issue.title, '[記事]')
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v3

      - name: Issue内容からファイルを作成
        id: generate
        run: |
          mkdir -p docs/contents

          ISSUE_NUMBER=${{ github.event.issue.number }}
          TITLE=$(echo "${{ github.event.issue.title }}" | sed 's/^\[記事\] //')
          DATE=$(date "+%Y-%m-%d")
          FILENAME="docs/contents/${DATE}-${ISSUE_NUMBER}.md"

          AUTHOR=$(echo "${{ github.event.issue.body }}" | grep -i "著者名" | head -n1 | sed 's/^.*:\s*//' || echo "unknown")
          TAGS=$(echo "${{ github.event.issue.body }}" | grep -i "タグ" | head -n1 | sed 's/^.*:\s*//' | sed 's/, */, /g')

          echo "作成するファイル: $FILENAME"
          echo "title: $TITLE"
          echo "author: $AUTHOR"
          echo "tags: [$TAGS]"
          echo <<EOF > $FILENAME
          echo '---' > $FILENAME
          echo 'title: "$TITLE"' > $FILENAME
          echo 'author: "$AUTHOR"' > $FILENAME
          echo 'date: "$DATE"' > $FILENAME
          echo 'tags: [${TAGS}]' > $FILENAME
          echo  '---' > $FILENAME
          echo "${{ github.event.issue.body }}" > $FILENAME

          echo "filename=$FILENAME" >> $GITHUB_OUTPUT

      - name: Gitブランチ作成・コミット・PR作成
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "投稿記事: ${{ github.event.issue.title }}"
          branch: "post/${{ github.event.issue.number }}"
          base: dev
          title: "${{ github.event.issue.title }}"
          body: "このPRは Issue #${{ github.event.issue.number }} から自動生成されました。"
          add-path: docs/contents/*.md
